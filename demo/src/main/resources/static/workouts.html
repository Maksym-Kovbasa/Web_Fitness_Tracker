<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>Workouts</title>
    <link rel="stylesheet" href="style/workouts.css">
</head>

<body>
    <div class="user-info" id="userInfo"></div>
    <div class="wrapper">
        <div class="list-workouts">
            <h2>Список тренувань</h2>
            <div id="error" class="error"></div>
            <table id="workoutsTable">
                <thead>
                    <tr>
                        <th>Користувач</th>
                        <th>Тип</th>
                        <th>Тривалість (хв)</th>
                        <th>Калорії</th>
                        <th>Дата</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="add-workout">
            <h3>Додати тренування</h3>
            <form id="addWorkoutForm">
                <input type="text" name="type" placeholder="Тип (наприклад, біг)" required>
                <input type="number" name="duration" placeholder="Тривалість (хв)" required>
                <input type="number" name="calories" placeholder="Калорії" required>
                <input type="date" name="date" required>
                <button type="submit">Додати</button>
            </form>
        </div>
    </div>
    <div class="nav-links">
        <a href="/goals.html">My Goals</a>
    </div>
    <script>
        let currentUsername = null;
        async function getCurrentUsername() {
            const res = await fetch('/api/users/me');
            currentUsername = await res.text();
            document.getElementById('userInfo').innerText = currentUsername;
        }

        async function loadWorkouts() {
            const res = await fetch('/api/workouts');
            const workouts = await res.json();
            const tbody = document.querySelector('#workoutsTable tbody');
            tbody.innerHTML = '';
            await getCurrentUsername();
            workouts.forEach(w => {
                tbody.innerHTML += `
                <tr>
                    <td>${w.user ? w.user.username : ''}</td>
                    <td>${w.type}</td>
                    <td>${w.duration}</td>
                    <td>${w.calories}</td>
                    <td>${w.date}</td>
                    <td>
                        ${w.user && w.user.username === currentUsername
                        ? `<button onclick="deleteWorkout(${w.id})">Видалити</button>`
                        : ''}
                    </td>
                </tr>
            `;
            });
        }

        async function deleteWorkout(id) {
            if (!confirm('Видалити тренування?')) return;
            await fetch('/api/workouts/' + id, { method: 'DELETE' });
            loadWorkouts();
        }

        document.getElementById('addWorkoutForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                type: form.type.value,
                duration: Number(form.duration.value),
                calories: Number(form.calories.value),
                date: form.date.value
            };
            const res = await fetch('/api/workouts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                form.reset();
                document.getElementById('error').innerText = '';
                loadWorkouts();
            } else {
                const text = await res.text();
                document.getElementById('error').innerText = text;
            }
        });

        loadWorkouts();
    </script>
</body>

</html>