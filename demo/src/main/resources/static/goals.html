<!DOCTYPE html>
<html>
<head>
    <title>Fitness Goals</title>
    <link rel="stylesheet" href="style/goals.css">
</head>
<body>
    <div class="wrapper-add">
        <div class="fitness-goal">
            <form id="goalForm">
                <h2>New Goal</h2>
                <div class="input-field">
                    <input type="number" name="targetCalories" required>
                    <label>Target Calories</label>
                </div>
                <div class="input-field">
                    <input type="number" name="targetWorkouts" required>
                    <label>Target Workouts</label>
                </div>
                <div class="input-field">
                    <input type="date" name="startDate" class="date always-focused" required>
                    <label>Start Date</label>
                </div>
                <div class="input-field">
                    <input type="date" name="endDate" class="date always-focused" required>
                    <label>End Date</label>
                </div>
                <button type="submit">Add Goal</button>
            </form>
        </div>
    </div>

    <div class="wrapper-list">
        <div class="list-goal">
            <h2>My Fitness Goals</h2>
        </div>
    </div>

    <script>
        async function checkAuth() {
            try {
                const response = await fetch('/api/goals', {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }

        async function loadGoals() {
            try {
                if (!await checkAuth()) return;

                const response = await fetch('/api/goals', {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const goals = await response.json();
                console.log('Goals loaded:', goals);
                displayGoals(goals);
            } catch (error) {
                console.error('Error loading goals:', error);
                const container = document.querySelector('.list-goal');
                container.innerHTML = '<div class="error">Failed to load goals. Please try again later.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadGoals);
        document.getElementById('goalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!await checkAuth()) return;

            const form = e.target;
            const data = {
                targetCalories: parseInt(form.targetCalories.value),
                targetWorkouts: parseInt(form.targetWorkouts.value),
                startDate: form.startDate.value,
                endDate: form.endDate.value
            };

            try {
                const response = await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    form.reset();
                    await loadGoals();
                } else if (response.status === 401) {
                    window.location.href = '/login.html';
                } else {
                    const error = await response.text();
                    alert(error || 'Failed to create goal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create goal');
            }
        });

        async function deleteGoal(id) {
            if (!await checkAuth()) return;
            if (!confirm('Are you sure you want to delete this goal?')) return;

            try {
                const response = await fetch(`/api/goals/${id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    await loadGoals();
                } else if (response.status === 401) {
                    window.location.href = '/login.html';
                } else {
                    alert('Failed to delete goal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete goal');
            }
        }

        function displayGoals(goals) {
            const container = document.querySelector('.list-goal');
            
            let content = '<h2>My Fitness Goals</h2>';
            
            if (!Array.isArray(goals)) {
                console.error('Goals is not an array:', goals);
                content += '<div class="error">Invalid data received from server</div>';
                container.innerHTML = content;
                return;
            }

            if (goals.length === 0) {
                content += '<div class="info">No goals yet. Create your first goal!</div>';
                container.innerHTML = content;
                return;
            }

            content += goals.map(goal => {
                
                return `
                    <div class="goal-card">
                        <h3>Goal</h3>
                        <p>Target Calories: ${goal.targetCalories || 0}</p>
                        <p>Target Workouts: ${goal.targetWorkouts || 0}</p>
                        <p>Workout Progress: ${goal.workoutProgress || 0}%</p>
                        <p>Start Date: ${formatDate(goal.startDate)}</p>
                        <p>End Date: ${formatDate(goal.endDate)}</p>
                        <p>Status: ${goal.status}</p>
                        <button onclick="deleteGoal(${goal.id})" class="delete-btn">Delete</button>
                    </div>
                `;
            }).join('');

            container.innerHTML = content;
        }

        
       

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
    </script>
</body>
</html>